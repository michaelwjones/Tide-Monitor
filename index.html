<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tide Monitor - Recent Readings</title>
    <style>
        table, th, td {
            border: 1px solid black;
        }
        table {
            border-collapse: collapse;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
    <h1>Tide Monitor - Last 24 Hours</h1>
    
    <h2>Water Level Chart</h2>
    <canvas id="waterLevelChart" width="800" height="400"></canvas>
    
    <h2>Recent Readings</h2>
    <div id="readings">
        <table>
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Water Level (ft)</th>
                    <th>Frequency (Hz)</th>
                    <th>Magnitude</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr>
                    <td colspan="4">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>

    <script>
        window.addEventListener('load', function() {
            fetchTideData();
        });

        async function fetchTideData() {
            const response = await fetch('https://tide-monitor-boron-default-rtdb.firebaseio.com/readings/.json?orderBy="$key"&limitToLast=1440');
            const data = await response.json();
            
            const readings = Object.entries(data).map(([key, value]) => ({
                id: key,
                timestamp: new Date(value.t).toLocaleString('en-US', { 
                    timeZone: 'America/New_York',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                }),
                rawTimestamp: new Date(value.t),
                frequency: value.f,
                magnitude: value.m,
                waterLevel: (value.w / 304.8).toFixed(2)
            }));
            
            // Create chart with all data
            createChart(readings);
            
            // Get only the last 10 readings and reverse to show most recent first
            const last10 = readings.slice(-10).reverse();
            
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = last10.map(reading => `
                <tr>
                    <td>${reading.timestamp}</td>
                    <td>${reading.waterLevel}</td>
                    <td>${reading.frequency}</td>
                    <td>${reading.magnitude}</td>
                </tr>
            `).join('');
        }

        function createChart(readings) {
            const ctx = document.getElementById('waterLevelChart').getContext('2d');
            
            // Filter out any invalid timestamps and get min/max times
            const validReadings = readings.filter(r => r.rawTimestamp.getTime() > 0);
            const timestamps = validReadings.map(r => r.rawTimestamp);
            const minTime = new Date(Math.min(...timestamps));
            const maxTime = new Date(Math.max(...timestamps));
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: validReadings.map(r => r.rawTimestamp),
                    datasets: [{
                        label: 'Water Level (ft)',
                        data: validReadings.map(r => parseFloat(r.waterLevel)),
                        borderColor: 'blue',
                        backgroundColor: 'rgba(0, 0, 255, 0.1)',
                        borderWidth: 2,
                        pointRadius: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            min: -10,
                            max: 10,
                            title: {
                                display: true,
                                text: 'Water Level (feet)'
                            }
                        },
                        x: {
                            type: 'time',
                            min: minTime,
                            max: maxTime,
                            time: {
                                displayFormats: {
                                    hour: 'MMM DD HH:mm'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Water Level Over Last 24 Hours'
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
