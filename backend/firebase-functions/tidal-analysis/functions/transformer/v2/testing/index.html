<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformer v2 - Training Data Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .stat-label {
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 30px;
            background-color: white;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.active {
            background-color: #28a745;
        }
        select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .error {
            color: #dc3545;
            text-align: center;
            padding: 20px;
            background-color: #f8d7da;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Transformer v2 - Training Data Analysis</h1>
            <p>Visual inspection of processed training sequences before model training</p>
        </div>

        <div id="loading" class="loading">
            <p>Loading training data...</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="content" style="display: none;">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="total-sequences">-</div>
                    <div class="stat-label">Total Training Sequences</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="input-length">-</div>
                    <div class="stat-label">Input Length (10-min intervals)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="output-length">-</div>
                    <div class="stat-label">Output Length (10-min intervals)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="data-range">-</div>
                    <div class="stat-label">Data Value Range</div>
                </div>
            </div>

            <div class="controls">
                <label>Sequence to visualize:</label>
                <select id="sequence-selector">
                    <option value="0">Sequence 1</option>
                </select>
                <button id="random-sequence">Random Sequence</button>
                <button id="show-distribution">Show Data Distribution</button>
                <span style="color: #666; font-size: 12px; margin-left: 20px;" id="sequence-count">
                    (Loading all sequences...)
                </span>
            </div>

            <div class="controls" id="inference-controls" style="margin-top: 15px; display: none;">
                <label>Model Inference:</label>
                <button id="run-inference">Run Prediction on Current Sequence</button>
                <button id="inference-status">Check Model Status</button>
                <span id="inference-info" style="color: #666; font-size: 12px; margin-left: 20px;">
                    (Checking model availability...)
                </span>
            </div>

            <div class="chart-container">
                <canvas id="sequence-chart"></canvas>
            </div>

            <div class="chart-container">
                <canvas id="distribution-chart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let trainingDataX = null;
        let trainingDataY = null;
        let validationDataX = null;
        let validationDataY = null;
        let metadata = null;
        let normParams = null;
        let sequenceChart = null;
        let distributionChart = null;

        async function loadData() {
            try {
                // Load all data files
                const responses = await Promise.all([
                    fetch('/data/X_train.npy'),
                    fetch('/data/y_train.npy'), 
                    fetch('/data/X_val.npy'),
                    fetch('/data/y_val.npy'),
                    fetch('/data/metadata.json'),
                    fetch('/data/normalization_params.json')
                ]);

                if (!responses.every(r => r.ok)) {
                    throw new Error('Failed to load data files');
                }

                // Parse all data
                trainingDataX = await responses[0].json();
                trainingDataY = await responses[1].json();
                validationDataX = await responses[2].json();
                validationDataY = await responses[3].json();
                metadata = await responses[4].json();
                normParams = await responses[5].json();
                
                console.log('Loaded training data:', trainingDataX.shape, trainingDataY.shape);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                
                updateStats();
                initializeCharts();
                setupControls();

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error').textContent = `Error loading data: ${error.message}. Make sure the Python server is running and data files exist.`;
            }
        }

        function updateStats() {
            document.getElementById('total-sequences').textContent = metadata.train_sequences.toLocaleString();
            document.getElementById('input-length').textContent = metadata.input_length;
            document.getElementById('output-length').textContent = metadata.output_length;
            
            if (trainingDataX && trainingDataX.stats) {
                const stats = trainingDataX.stats;
                document.getElementById('data-range').textContent = `${stats.min.toFixed(2)} to ${stats.max.toFixed(2)}`;
            } else {
                document.getElementById('data-range').textContent = 'Loading...';
            }
        }

        function initializeCharts() {
            // Initialize sequence visualization chart
            const seqCtx = document.getElementById('sequence-chart').getContext('2d');
            sequenceChart = new Chart(seqCtx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Input Sequence (72h)',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'Target Output (24h)',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time Steps (10-minute intervals)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Normalized Water Level'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Training Sequence Visualization'
                        }
                    }
                }
            });

            // Initialize distribution chart
            const distCtx = document.getElementById('distribution-chart').getContext('2d');
            distributionChart = new Chart(distCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Value Distribution',
                        data: [],
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Data Distribution (All Training Sequences)'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Normalized Value Range'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Frequency'
                            }
                        }
                    }
                }
            });
        }

        function setupControls() {
            // Populate sequence selector with only available sequences
            const selector = document.getElementById('sequence-selector');
            const availableSequences = trainingDataX ? trainingDataX.data.length : 0;
            
            console.log(`Available sequences: ${availableSequences}`);
            
            // Clear existing options
            selector.innerHTML = '';
            
            for (let i = 0; i < availableSequences; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Sequence ${i + 1}`;
                selector.appendChild(option);
            }
            
            // Update sequence count display
            document.getElementById('sequence-count').textContent = `(${availableSequences} sequences loaded)`;

            // Add event listeners
            document.getElementById('random-sequence').addEventListener('click', () => {
                const randomIndex = Math.floor(Math.random() * availableSequences);
                selector.value = randomIndex;
                selector.dispatchEvent(new Event('change'));
            });

            selector.addEventListener('change', (e) => {
                showSequence(parseInt(e.target.value));
            });

            document.getElementById('show-distribution').addEventListener('click', showDistribution);

            // Show first sequence by default
            showSequence(0);
        }

        function showSequence(index) {
            if (!trainingDataX || !trainingDataY || !trainingDataX.data || !trainingDataY.data) {
                console.error('Training data not loaded yet');
                return;
            }

            // Get the actual sequence data from loaded NumPy arrays
            const inputData = trainingDataX.data[index] || [];
            const outputData = trainingDataY.data[index] || [];
            
            console.log(`Showing sequence ${index}: input length=${inputData.length}, output length=${outputData.length}`);

            // Create labels for x-axis (time steps)
            const inputLabels = Array.from({length: inputData.length}, (_, i) => i);
            const outputLabels = Array.from({length: outputData.length}, (_, i) => i + inputData.length);
            
            // Update chart with actual training data
            sequenceChart.data.labels = [...inputLabels, ...outputLabels];
            sequenceChart.data.datasets[0].data = inputData;
            sequenceChart.data.datasets[1].data = new Array(inputData.length).fill(null).concat(outputData);
            sequenceChart.update();
        }

        function showDistribution() {
            if (!trainingDataX || !trainingDataX.data) {
                console.error('Training data not loaded yet');
                return;
            }

            // Flatten all training data for distribution analysis
            const allValues = trainingDataX.data.flat();
            
            // Create histogram bins
            const minVal = Math.min(...allValues);
            const maxVal = Math.max(...allValues);
            const numBins = 50;
            const binSize = (maxVal - minVal) / numBins;
            
            const bins = [];
            const counts = new Array(numBins).fill(0);
            
            // Create bin labels
            for (let i = 0; i < numBins; i++) {
                const binStart = minVal + i * binSize;
                bins.push(binStart.toFixed(2));
            }
            
            // Count values in each bin
            allValues.forEach(value => {
                const binIndex = Math.min(Math.floor((value - minVal) / binSize), numBins - 1);
                counts[binIndex]++;
            });

            distributionChart.data.labels = bins;
            distributionChart.data.datasets[0].data = counts;
            distributionChart.update();
        }

        // Inference functionality
        let currentPrediction = null;

        async function checkInferenceStatus() {
            try {
                const response = await fetch('/inference/status');
                const status = await response.json();
                
                const infoSpan = document.getElementById('inference-info');
                if (response.ok && status.status === 'ready') {
                    infoSpan.textContent = `Model ready (${status.device})`;
                    infoSpan.style.color = '#28a745';
                    document.getElementById('inference-controls').style.display = 'block';
                } else {
                    infoSpan.textContent = 'Model not available';
                    infoSpan.style.color = '#dc3545';
                }
            } catch (error) {
                const infoSpan = document.getElementById('inference-info');
                infoSpan.textContent = 'Inference service unavailable';
                infoSpan.style.color = '#dc3545';
            }
        }

        async function runInference() {
            const sequenceIndex = parseInt(document.getElementById('sequence-selector').value);
            const button = document.getElementById('run-inference');
            
            button.disabled = true;
            button.textContent = 'Running prediction...';
            
            try {
                const response = await fetch(`/inference/predict_sequence?index=${sequenceIndex}`);
                const result = await response.json();
                
                if (response.ok) {
                    currentPrediction = result;
                    updateChartWithPrediction();
                    button.textContent = 'Prediction Complete';
                    setTimeout(() => {
                        button.textContent = 'Run Prediction on Current Sequence';
                        button.disabled = false;
                    }, 2000);
                } else {
                    alert(`Prediction failed: ${result.error}`);
                    button.textContent = 'Run Prediction on Current Sequence';
                    button.disabled = false;
                }
            } catch (error) {
                alert(`Prediction error: ${error.message}`);
                button.textContent = 'Run Prediction on Current Sequence';
                button.disabled = false;
            }
        }

        function updateChartWithPrediction() {
            if (!currentPrediction || !sequenceChart) return;

            // Add prediction data to the chart
            const inputLength = currentPrediction.input.length;
            const predictionData = currentPrediction.prediction.map((value, index) => ({
                x: inputLength + index,
                y: value
            }));

            // Find or create the prediction dataset
            let predictionDataset = sequenceChart.data.datasets.find(ds => ds.label === 'Model Prediction');
            if (!predictionDataset) {
                predictionDataset = {
                    label: 'Model Prediction',
                    data: predictionData,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    pointRadius: 2,
                    borderDash: [5, 5]
                };
                sequenceChart.data.datasets.push(predictionDataset);
            } else {
                predictionDataset.data = predictionData;
            }

            sequenceChart.update();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            
            // Check inference status after a short delay
            setTimeout(checkInferenceStatus, 1000);
            
            // Inference controls
            document.getElementById('run-inference').addEventListener('click', runInference);
            document.getElementById('inference-status').addEventListener('click', checkInferenceStatus);
            
            // Clear prediction when sequence changes
            document.getElementById('sequence-selector').addEventListener('change', () => {
                currentPrediction = null;
                if (sequenceChart) {
                    // Remove prediction dataset
                    sequenceChart.data.datasets = sequenceChart.data.datasets.filter(ds => ds.label !== 'Model Prediction');
                    sequenceChart.update();
                }
            });
        });

        // Load data when page loads
        // document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>